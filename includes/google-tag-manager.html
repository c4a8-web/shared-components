{% if jekyll.environment == "production" and site.google_tag_manager_id %}
  <!-- Google Tag Manager - DEV -->
  <script>

    // Intercept any cookies
    // Original document.cookie value
    const originalDocumentCookie = document.cookie;

    // Function to intercept cookie writes
    function interceptCookieWrite(cookieValue) {
      console.log(`Intercepted cookie write: ${cookieValue}`);
        
      // Store the intercepted cookie data in local storage
      const cookieData = cookieValue.split(';')[0]; // Extract the cookie name and value
      const [cookieName, cookieContent] = cookieData.split('=');

      // Store the cookie in local storage
      localStorage.setItem(cookieName.trim(), cookieContent.trim());
    }

    // Function to intercept cookie reads and return data from local storage
    function interceptCookieRead(cookieName) {
      console.log(`Intercepted cookie read: ${cookieName}`);

      // Check if the cookie exists in local storage
      const storedCookieValue = localStorage.getItem(cookieName);

      if (storedCookieValue !== null) {
        // If found in local storage, return the value
        console.log(`Cookie data retrieved from local storage: ${storedCookieValue}`);
        return `${cookieName}=${storedCookieValue}`;
      }
    }    

    // Override the document.cookie property setter
    Object.defineProperty(document, 'cookie', {
      set: function (cookieValue) {
        interceptCookieWrite(cookieValue);
      },
      configurable: true,
    });

    // Override the document.cookie property getter
    Object.defineProperty(document, 'cookie', {
      get: function () {
        // Use a regular expression to match cookie names like '_ga_XXXXX' where 'XXXXX' can be any string
        const cookieNames = Object.keys(localStorage).filter((key) => /^_ga_[\w-]+$/.test(key));

        console.log(`GET INTERCEPT - Cookie data retrieved from local storage: ${cookieNames}`);

        // Loop through matched cookie names and intercept the read operation
        for (const cookieName of cookieNames) {
          const interceptedValue = interceptCookieRead(cookieName);
          if (interceptedValue) {
            return interceptedValue;
          }
        }
      },
      configurable: true,
    });

    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag("consent", "default", {
        ad_user_data: "denied",
        ad_personalization: "denied",
        ad_storage: "denied",
        personalization_storage: "denied",
        functionality_storage: "denied",
        security_storage: "denied",
        analytics_storage: "granted",
        wait_for_update: 500,
    });
    gtag("set", "ads_data_redaction", true);

  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://{{ site.google_tag_manager_domain }}/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ site.google_tag_manager_id }}');</script>
  <!-- End Google Tag Manager -->
{% endif %}
